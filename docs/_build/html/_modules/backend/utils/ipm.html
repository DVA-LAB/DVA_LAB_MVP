<!DOCTYPE html>
<html class="writer-html5" lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>backend.utils.ipm &mdash; DVA Lab  문서</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="색인" href="../../../genindex.html" />
    <link rel="search" title="검색" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DVA Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">backend</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../backend.api.html">backend.api package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backend.interface.html">backend.interface package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../models.BEV.html">models.BEV package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.bytetrack.html">models.bytetrack package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.efficientAD.html">models.efficientAD package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.refiner.html">models.refiner package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DVA Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">모듈 코드</a></li>
      <li class="breadcrumb-item active">backend.utils.ipm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>backend.utils.ipm의 소스 코드</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">PIL.ExifTags</span> <span class="kn">import</span> <span class="n">TAGS</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span> <span class="k">as</span> <span class="n">R</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    
<div class="viewcode-block" id="IPM"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.IPM">[문서]</a><span class="k">class</span> <span class="nc">IPM</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        원본 프레임을 BirdEyeView (BEV)로 변환합니다. (Inverse Perspective Mapping)</span>

<span class="sd">        BEV 변환을 위해 Pin-hole 카메라를 가정합니다.</span>

<span class="sd">        `_c`: 카메라 좌표</span>
<span class="sd">        `_w`: 월드 좌표</span>
<span class="sd">        `uv`: 입력 이미지에 대해 원근변환 된 uv 2D 좌표</span>

<span class="sd">        Inverse perspective mapping to a bird-eye view. Assume pin-hole camera model.</span>
<span class="sd">        There are detailed explanation of every step in the comments, and variable names in the code follow these conventions:</span>
<span class="sd">        `_c` for camera coordinates</span>
<span class="sd">        `_w` for world coordinates</span>
<span class="sd">        `uv` for perspective transformed uv 2d coordinates (the input image)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_info</span><span class="p">,</span> <span class="n">ipm_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ?</span>

<span class="sd">            Args</span>
<span class="sd">                - camera_info (?): ?</span>
<span class="sd">                - ipm_info (?): ?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span> <span class="o">=</span> <span class="n">camera_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipm_info</span> <span class="o">=</span> <span class="n">ipm_info</span>

        <span class="c1">## Construct matrices T, R, K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">camera_info</span><span class="o">.</span><span class="n">camera_height</span> <span class="c1"># 4x4 translation matrix in 3d space (3d homo coordinate)</span>
        
        <span class="n">_cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">camera_info</span><span class="o">.</span><span class="n">yaw</span>   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="n">_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">camera_info</span><span class="o">.</span><span class="n">yaw</span>   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="n">_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">camera_info</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="n">_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">camera_info</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="c1"># _cr = np.cos(camera_info.roll * np.pi / 180.)</span>
        <span class="c1"># _sr = np.sin(camera_info.roll * np.pi / 180.)</span>
        
        <span class="c1"># troll = np.array([[_cr, -_sr, 0],</span>
        <span class="c1">#                  [_sr, _cr, 0],</span>
        <span class="c1">#                  [0, 0, 1]]) #z</span>
        <span class="c1"># tyaw = np.array([[_cy, 0, -_sy],</span>
        <span class="c1">#                  [0, 1, 0],</span>
        <span class="c1">#                  [_sy, 0, _cy]]) #y</span>
        <span class="n">tpitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">_cp</span><span class="p">,</span> <span class="o">-</span><span class="n">_sp</span><span class="p">],</span>
                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">_sp</span><span class="p">,</span> <span class="n">_cp</span><span class="p">]])</span> <span class="c1">#x</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">tpitch</span> <span class="c1">#yxz # 3x3 Rotation matrix in 3d space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="c1"># 역행렬 계산</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">camera_info</span><span class="o">.</span><span class="n">f_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">.</span><span class="n">u_x</span><span class="p">],</span>
                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">.</span><span class="n">f_y</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">.</span><span class="n">u_y</span><span class="p">],</span>
                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># 3x3 intrinsic perspective projection matrix</span>

        <span class="c1">## The ground plane z=0 in the world coordinates, transform to a plane `np.dot(self.normal_c, point) = self.const_c` in the camera coordinates. </span>
        <span class="c1"># This is used to find (x,y,z)_c according to (u,v). See method `uv2xy` for detail.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normal_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="c1"># normal of ground plane equation in camera coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normal_c</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                              <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">])[:</span><span class="mi">3</span><span class="p">]))</span> <span class="c1"># constant of ground plane equation in camera coordinates</span>

        <span class="c1">## Get the limit to be converted on the uv map (must below vanishing point)</span>
        <span class="c1"># To calculate (u,v) of the vanishing point on the uv map of delta vector v=[0,1,0] in the world coordinates</span>
        <span class="c1"># homo coordinates of a vector will be v_4 = [0, 1, 0, 0], mapping this vector to camera coordinate:</span>
        <span class="c1"># vc_3 = np.dot(R_4, np.dot(T_4, v_4))[:3] = np.dot(R, v), the 2d homo coordinate of the vanishing point will be at </span>
        <span class="c1"># lim_{\lambda -&gt; \infty} np.dot(K, lambda * vc_3) = np.dot(K, vc_3)</span>

        <span class="c1"># lane_vec_c = np.dot(self.R, np.array([0,1,0])[:, None]) # lane vector in camera coordinates</span>
        <span class="c1"># lane_vec_homo_uv = np.dot(self.K, lane_vec) # lane vector on uv map (2d homo coordinate)</span>
        <span class="n">lane_vec_homo_uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]))</span> <span class="c1"># lane vector on uv map (2d homo coordinate)</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">lane_vec_homo_uv</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">lane_vec_homo_uv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># coordinates of the vanishing point of lanes on uv map</span>
        
        <span class="c1"># UGLY: This is an ugly op to ensure the converted area do not goes beyond the vanishing point, as the camera intrinsic/extrinsic parameters are not accurate in my case.</span>
        <span class="n">ipm_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipm_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">vp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">input_height</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> 
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ipm_top</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ipm_top</span> <span class="o">=</span> <span class="n">ipm_top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">uv_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">ipm_top</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">ipm_top</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">vp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ipm_top</span><span class="p">],</span>
                              <span class="p">[</span><span class="n">vp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">bottom</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># the limits of the area on the uv map to be IPM-converted</span>

        <span class="c1">## The x,y limit in the world coordinates is used to calculate xy_grid, and then the corresponding uv_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv2xy</span><span class="p">(</span><span class="n">uv_limits</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">stepx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">out_width</span>  <span class="c1"># x to output pixel ratio</span>
        <span class="n">stepy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">out_height</span> <span class="c1"># y to output pixel ratio</span>

        <span class="c1"># xy_grid: what x,y coordinates in world coordinates will be stored in every output image pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[(</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">stepx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">stepy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">out_width</span><span class="p">)]</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ipm_info</span><span class="o">.</span><span class="n">out_height</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># uv_grid: what u,v coordiantes on the uv map will be stored in every output image pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy2uv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_grid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="o">*</span>\
                                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ipm_top</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">bottom</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">out_height</span><span class="p">,</span> <span class="n">ipm_info</span><span class="o">.</span><span class="n">out_width</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="IPM.xy2uv"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.IPM.xy2uv">[문서]</a>    <span class="k">def</span> <span class="nf">xy2uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xys</span><span class="p">):</span> <span class="c1"># all points have z=0 (ground plane): w (u,v,1) = KRT (x,y,z)_w</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ?</span>

<span class="sd">            Args</span>
<span class="sd">                - xys (?): ?</span>

<span class="sd">            Return</span>
<span class="sd">                - xy_w (?): ?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># x축 좌표 반전</span>
        <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">xyzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xys</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span><span class="o">.</span><span class="n">camera_height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span> <span class="c1"># (x,y,z) after translation</span>
        <span class="n">xyzs_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">xyzs</span><span class="p">))</span> <span class="c1"># w(u,v,1) (2d homo)</span>
        <span class="k">return</span> <span class="n">xyzs_c</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">xyzs_c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>

<div class="viewcode-block" id="IPM.uv2xy"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.IPM.uv2xy">[문서]</a>    <span class="k">def</span> <span class="nf">uv2xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uvs</span><span class="p">):</span> <span class="c1"># all points have z=0 (ground plane): find (x,y,z)_c first, then x_w, y_w = (R^-1 (x,y,z)_c)[:2]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ?</span>

<span class="sd">            Args</span>
<span class="sd">                - uvs (?): ?</span>

<span class="sd">            Return</span>
<span class="sd">                - xy_w (?): ?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">uvs</span> <span class="o">=</span> <span class="p">(</span><span class="n">uvs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span><span class="o">.</span><span class="n">u_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span><span class="o">.</span><span class="n">u_y</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">/</span>\
              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span><span class="o">.</span><span class="n">f_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_info</span><span class="o">.</span><span class="n">f_y</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="c1"># converted using camara intrinsic parameters</span>
        <span class="n">uvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">uvs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">uvs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">xyz_c</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const_c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normal_c</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">uvs</span><span class="p">))</span> <span class="o">*</span> <span class="n">uvs</span> <span class="c1"># solve the equation, get (x,y,z) on the ground plane in camera coordinates</span>
        <span class="n">xy_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">,</span> <span class="n">xyz_c</span><span class="p">)[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># (x, y) on the ground plane in the world coordinates</span>
        <span class="c1"># x축 좌표 반전</span>
        <span class="n">xy_w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xy_w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">xy_w</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipm</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<div class="viewcode-block" id="IPM.ipm"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.IPM.ipm">[문서]</a>    <span class="k">def</span> <span class="nf">ipm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           ?</span>

<span class="sd">           Args</span>
<span class="sd">                - img (?): ?</span>

<span class="sd">           Return</span>
<span class="sd">                - ? (?): ?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">]</span></div>

<div class="viewcode-block" id="IPM.reverse_ipm"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.IPM.reverse_ipm">[문서]</a>    <span class="k">def</span> <span class="nf">reverse_ipm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ?</span>

<span class="sd">            Args</span>
<span class="sd">                - img (?): ?</span>
<span class="sd">                - shape (tuple): ?</span>
<span class="sd">            </span>
<span class="sd">            Return</span>
<span class="sd">                - out_img (?): ?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out_img</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_grid</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">return</span> <span class="n">out_img</span></div></div>


<span class="k">class</span> <span class="nc">_DictObjHolder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dct</span> <span class="o">=</span> <span class="n">dct</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dct</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<div class="viewcode-block" id="get_file_path"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.get_file_path">[문서]</a><span class="k">def</span> <span class="nf">get_file_path</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        특정 디렉터리 하위에 존재하는 jpg 파일 경로 목록을 추출합니다.</span>

<span class="sd">        Args</span>
<span class="sd">            - directory (str): 디렉터리 경로</span>

<span class="sd">        Return</span>
<span class="sd">            - filepaths (list): jpg 파일 경로 목록</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.jpg&#39;</span><span class="p">):</span>
                <span class="n">filepaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">filepaths</span></div>

<div class="viewcode-block" id="extract_exif"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.extract_exif">[문서]</a><span class="k">def</span> <span class="nf">extract_exif</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        jpg 파일에서 EXIF 정보를 추출합니다.</span>

<span class="sd">        Args</span>
<span class="sd">            - filepath (str): jpg 파일 경로</span>

<span class="sd">        Return</span>
<span class="sd">            - exif_table (dict): EXIF 정보가 매핑된 정보</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">image</span>       <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">info</span>        <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_getexif</span><span class="p">()</span>
    <span class="n">exif_table</span>  <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">TAGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="n">exif_table</span><span class="p">[</span><span class="n">decoded</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">image</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">exif_table</span></div>

<div class="viewcode-block" id="extract_xmp"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.extract_xmp">[문서]</a><span class="k">def</span> <span class="nf">extract_xmp</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        jpg 파일에서 XMP 정보를 추출합니다.</span>

<span class="sd">        Args</span>
<span class="sd">            - filepath (str): jpg 파일 경로</span>

<span class="sd">        Return</span>
<span class="sd">            - xmp (tuple): xmp에서 추출한 드론 절대고도, 상대고도 비행 요 각도, 피치각도 롤각도, 짐벌의 요각도, 피치각도 롤각도</span>
<span class="sd">                - altitude_absolute (float): 드론 절대고도</span>
<span class="sd">                - altitude_relative (float): 드론 상대고도</span>
<span class="sd">                - flight_yaw (float): 드론이 yaw 축으로 회전한 각도</span>
<span class="sd">                - flight_pitch (float): 드론이 pitch 축으로 회전한 각도</span>
<span class="sd">                - flight_roll (float): 드론이 roll 축으로 회전한 각도</span>
<span class="sd">                - gimbal_yaw (float): 드론 짐벌 카메라가 yaw 축으로 회전한 각도</span>
<span class="sd">                - gimbal_pitch (float): 드론 짐벌 카메라가 pitch 축으로 회전한 각도</span>
<span class="sd">                - gimbal_roll (float): 드론 짐벌 카메라가 roll 축으로 회전한 각도</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span>        <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">xmp_start</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&lt;x:xmpmeta&#39;</span><span class="p">)</span>
        <span class="n">xmp_end</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&lt;/x:xmpmeta&#39;</span><span class="p">)</span>
        <span class="n">xmp_data</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">xmp_start</span> <span class="p">:</span> <span class="n">xmp_end</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span>
        
        <span class="n">pattern_absolute_altitude</span>       <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;AbsoluteAltitude=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_relative_altitude</span>       <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;RelativeAltitude=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_gimbal_yaw_degree</span>       <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;GimbalYawDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_gimbal_pitch_degree</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;GimbalPitchDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_gimbal_roll_degree</span>      <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;GimbalRollDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_flight_yaw_degree</span>       <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;FlightYawDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_flight_pitch_degree</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;FlightPitchDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        <span class="n">pattern_flight_roll_degree</span>      <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;FlightRollDegree=&quot;[+-]\d{1,}\.\d{1,}&quot;&#39;</span><span class="p">)</span>
        
        <span class="n">match_absolute_altitude</span>         <span class="o">=</span> <span class="n">pattern_absolute_altitude</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_relative_altitude</span>         <span class="o">=</span> <span class="n">pattern_relative_altitude</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_gimbal_yaw_degree</span>         <span class="o">=</span> <span class="n">pattern_gimbal_yaw_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_gimbal_pitch_degree</span>       <span class="o">=</span> <span class="n">pattern_gimbal_pitch_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_gimbal_roll_degree</span>        <span class="o">=</span> <span class="n">pattern_gimbal_roll_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_flight_yaw_degree</span>         <span class="o">=</span> <span class="n">pattern_flight_yaw_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_flight_pitch_degree</span>       <span class="o">=</span> <span class="n">pattern_flight_pitch_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        <span class="n">match_flight_roll_degree</span>        <span class="o">=</span> <span class="n">pattern_flight_roll_degree</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">xmp_data</span><span class="p">)</span>
        
        <span class="n">altitude_absolute</span>   <span class="o">=</span> <span class="n">match_absolute_altitude</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">altitude_relative</span>   <span class="o">=</span> <span class="n">match_relative_altitude</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">flight_yaw</span>          <span class="o">=</span> <span class="n">match_flight_yaw_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">flight_pitch</span>        <span class="o">=</span> <span class="n">match_flight_pitch_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">flight_roll</span>         <span class="o">=</span> <span class="n">match_flight_roll_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">gimbal_yaw</span>          <span class="o">=</span> <span class="n">match_gimbal_yaw_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">gimbal_pitch</span>        <span class="o">=</span> <span class="n">match_gimbal_pitch_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">gimbal_roll</span>         <span class="o">=</span> <span class="n">match_gimbal_roll_degree</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">altitude_absolute</span><span class="p">,</span> <span class="n">altitude_relative</span><span class="p">),</span> <span class="p">(</span><span class="n">flight_yaw</span><span class="p">,</span> <span class="n">flight_pitch</span><span class="p">,</span> <span class="n">flight_roll</span><span class="p">),</span> <span class="p">(</span><span class="n">gimbal_yaw</span><span class="p">,</span> <span class="n">gimbal_pitch</span><span class="p">,</span> <span class="n">gimbal_roll</span><span class="p">)</span></div>

<div class="viewcode-block" id="estimate_focal_length"><a class="viewcode-back" href="../../../backend.utils.ipm.html#backend.utils.ipm.estimate_focal_length">[문서]</a><span class="k">def</span> <span class="nf">estimate_focal_length</span><span class="p">(</span><span class="n">image_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fov_degrees</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        이미지 가로 길이와 FOV 가 주어졌을 때 focal length를 추정합니다.</span>

<span class="sd">        Args</span>
<span class="sd">            - image_width (float): 픽셀상의 이미지 가로 길이</span>
<span class="sd">            - fov_degrees (float): field of view in degree</span>
<span class="sd">    </span>
<span class="sd">        Return</span>
<span class="sd">            - 추정 된 픽셀 상의 focal length</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sensor_width_mm</span> <span class="o">=</span> <span class="mf">6.16</span>  <span class="c1"># for 1/2.3&quot; sensor, usually around 6.3mm</span>
    <span class="n">focal_length_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor_width_mm</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">fov_degrees</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">focal_length_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">focal_length_mm</span> <span class="o">/</span> <span class="n">sensor_width_mm</span><span class="p">)</span> <span class="o">*</span> <span class="n">image_width</span>
    <span class="k">return</span> <span class="n">focal_length_px</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_file_path</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">)</span> <span class="c1"># 스틸컷이 담긴 폴더명을 인자로 전달합니다.</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
        <span class="c1"># 이미지 로드</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">exif_table</span>  <span class="o">=</span> <span class="n">extract_exif</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">xmp</span>         <span class="o">=</span> <span class="n">extract_xmp</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">altitude</span><span class="p">,</span> <span class="n">flight_degree</span><span class="p">,</span> <span class="n">gimbal_degree</span> <span class="o">=</span> <span class="n">xmp</span>
        <span class="n">flight_yaw</span><span class="p">,</span> <span class="n">flight_pitch</span><span class="p">,</span> <span class="n">flight_roll</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">flight_degree</span><span class="p">)</span>
        <span class="n">gimbal_yaw</span><span class="p">,</span> <span class="n">gimbal_pitch</span><span class="p">,</span> <span class="n">gimbal_roll</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">gimbal_degree</span><span class="p">)</span>

        <span class="n">fov_degrees</span> <span class="o">=</span> <span class="mi">85</span>
        <span class="n">focal_length</span> <span class="o">=</span> <span class="n">estimate_focal_length</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fov_degrees</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">flight_yaw</span><span class="p">,</span> <span class="n">flight_pitch</span><span class="p">,</span> <span class="n">flight_roll</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gimbal_yaw</span><span class="p">,</span> <span class="n">gimbal_pitch</span><span class="p">,</span> <span class="n">gimbal_roll</span><span class="p">)</span>

        <span class="n">camera_info</span> <span class="o">=</span> <span class="n">_DictObjHolder</span><span class="p">({</span>
            <span class="s2">&quot;f_x&quot;</span><span class="p">:</span> <span class="n">focal_length</span><span class="p">,</span>             <span class="c1"># focal length x</span>
            <span class="s2">&quot;f_y&quot;</span><span class="p">:</span> <span class="n">focal_length</span><span class="p">,</span>             <span class="c1"># focal length y</span>
            <span class="s2">&quot;u_x&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>             <span class="c1"># optical center x</span>
            <span class="s2">&quot;u_y&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>             <span class="c1"># optical center y</span>
            <span class="s2">&quot;camera_height&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">altitude</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span>             <span class="c1"># camera height in `mm`</span>
            <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">gimbal_pitch</span><span class="p">,</span>             <span class="c1"># rotation degree around y</span>
            <span class="s2">&quot;yaw&quot;</span><span class="p">:</span> <span class="n">gimbal_yaw</span><span class="p">,</span>             <span class="c1"># rotation degree around z</span>
            <span class="s2">&quot;roll&quot;</span><span class="p">:</span> <span class="n">gimbal_roll</span>           <span class="c1"># rotation degree around x</span>
        <span class="p">})</span>

        <span class="n">ipm_info</span> <span class="o">=</span> <span class="n">_DictObjHolder</span><span class="p">({</span>
            <span class="s2">&quot;input_width&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;input_height&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;out_width&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;out_height&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">ipm</span> <span class="o">=</span> <span class="n">IPM</span><span class="p">(</span><span class="n">camera_info</span><span class="p">,</span> <span class="n">ipm_info</span><span class="p">)</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">ipm</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">reverse_out_img</span> <span class="o">=</span> <span class="n">ipm</span><span class="o">.</span><span class="n">reverse_ipm</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        
        <span class="c1"># 이미지를 그대로 BGR 형식으로 저장</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;./original_image.png&#39;</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;./ipm_output.png&#39;</span><span class="p">,</span> <span class="n">out_img</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;./reverse_output.png&#39;</span><span class="p">,</span> <span class="n">reverse_out_img</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 저작권 2023, DVA Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>